var PhoenixSocket=function(e){e=e||{endpoint:location.protocol.match(/^https/)?"wss://"+location.host+"/ws":"ws://"+location.host+"/ws",appName:"App",storeName:"DS"};var t=window[e.storeName],n=window[e.appName];n.Phoenix={};n.Phoenix.Socket=Ember.Controller.extend({socket:null,topics:null,init:function(){this.set("topics",Ember.Map.create());var t=new Phoenix.Socket(e.endpoint);t.onClose=this.get("handleClose").bind(this);this.set("socket",t)},addTopic:function(e,t,n,r){var i=e+":"+t;if(this.get("topics").get(i)){r(this.get("topics").get(i),true)}else{this.get("socket").join(e,t,n||{},this.get("handleAddTopic").bind(this,i,r))}},handleAddTopic:function(e,t,n){n.on("join",function(r){this.get("topics").set(e,n);t(n,r)}.bind(this));n.on("error",function(e){t("error",e)})},handleClose:function(){console.log("connection closed")}});n.Phoenix.Session=Ember.Controller.extend({needs:["phoenix"],channel:null,isAuthenticated:false,init:function(){},actions:{join:function(e,t,n){this.get("service:phoenix").addTopic("session","user",e,function(e,r){if(e=="error"){n(r)}else{this.set("isAuthenticated",true);this.set("channel",e);t(r)}}.bind(this))}}});n.Phoenix.Channel=t.PhoenixSocketAdapter=t.RESTAdapter.extend({needs:["phoenix","session"],topic:null,_initialized:false,_transactions:{},_channel:null,setSocket:function(e,t){this.set("topic",t);this.container.lookup("service:phoenix").addTopic(e,t,{},this.get("setSocketResponse").bind(this))},setSocketResponse:function(e,t){e.on(this.get("topic"),this.get("onData").bind(this));this.set("_channel",e);this.set("_initialized",true);this.get("unloadQueue").call(this)},onData:function(e){var t=this.get("_transactions")[e.uuid];if(e.success){t.success(e.message)}else{t.error(e.message)}t.destroy();delete t},unloadQueue:function(){var e=this.get("_transactions");for(var t in e){this.get("_channel").send(this.get("topic"),e[t].payload())}},ajax:function(e,t,r){var i=n.Phoenix.Utils.generateUuid();var s=this.get("_transactions")[i]=n.Phoenix.Transaction.create({uuid:i,url:e,type:t,params:r});if(this.get("_initialized")){this.get("_channel").send(this.get("topic"),s.payload())}return s.promise}});n.Phoenix.Transaction=Ember.Object.extend({uuid:null,url:null,type:null,params:null,promise:null,success:null,error:null,init:function(){var e=new Ember.RSVP.Promise(function(e,t){this.set("success",function(t){Ember.run(null,e,t)});this.set("error",function(e){Ember.run(null,t,e)})}.bind(this));this.set("promise",e)},payload:function(e,t,n){return{uuid:this.get("uuid"),type:this.get("type"),params:this.get("params"),path:this.get("derivePath").call(this)}},derivePath:function(){return this.get("url").replace(this.host,"")}});n.Phoenix.Utils={generateUuid:function(){var e=(new Date).getTime();var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+Math.random()*16)%16|0;e=Math.floor(e/16);return(t==="x"?n:n&7|8).toString(16)});return t}};Ember.onLoad("Ember.Application",function(e){e.initializer({name:"session",initialize:function(e,t){t.register("service:session",n.Phoenix.Session,{singleton:true});t.inject("controller","service:session","service:session")}});e.initializer({name:"phoenix",initialize:function(e,r){r.register("service:phoenix",n.Phoenix.Socket,{singleton:true});n.ApplicationAdapter=t.PhoenixSocketAdapter;e.lookup("adapter:application").setSocket("session","data");r.inject("service:session","service:phoenix","service:phoenix")}})})}